<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .quiz-title {
            font-size: 24px;
            font-weight: bold;
            color: #1a202c;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .stat-item {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .stat-waiting {
            background: #e2e8f0;
            color: #4a5568;
        }

        .stat-correct {
            background: #c6f6d5;
            color: #22543d;
        }

        .stat-incorrect {
            background: #fed7d7;
            color: #742a2a;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .responses-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .response-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: #f7fafc;
            border-left: 4px solid #cbd5e0;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .response-item.correct {
            background: #f0fff4;
            border-left-color: #48bb78;
        }

        .response-item.incorrect {
            background: #fff5f5;
            border-left-color: #f56565;
        }

        .response-info {
            flex: 1;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .response-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #718096;
        }

        .time-taken {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .correctness {
            font-size: 32px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .correctness.revealed {
            opacity: 1;
        }

        .correctness.correct {
            color: #48bb78;
        }

        .correctness.incorrect {
            color: #f56565;
        }

        .no-responses {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
            font-size: 18px;
        }

        .waiting-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 1.5s ease-in-out infinite;
            margin-left: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: white;
            padding: 8px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            z-index: 1000;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }

        .status-dot.disconnected {
            background: #f56565;
        }

        body {
            padding-top: 48px;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="connection-status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connected</span>
        </div>
        <div id="quizIdDisplay"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="quiz-title" id="quizTitle">Waiting for quiz...</div>
            <div class="stats">
                <div class="stat-item stat-waiting">
                    Waiting: <span id="waitingCount">0</span>
                </div>
                <div class="stat-item stat-correct">
                    Correct: <span id="correctCount">0</span>
                </div>
                <div class="stat-item stat-incorrect">
                    Incorrect: <span id="incorrectCount">0</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-success" id="revealBtn" onclick="revealCorrectness()">
                üîç Reveal All Correctness
            </button>
            <button class="btn btn-danger" id="hideBtn" onclick="hideCorrectness()" style="display: none;">
                üëÅÔ∏è Hide Correctness
            </button>
            <button class="btn btn-primary" onclick="showRankings()">
                üèÜ Course Rankings
            </button>
            <button class="btn btn-primary" onclick="clearResponses()">
                üóëÔ∏è Clear
            </button>
        </div>

        <div class="responses-container" id="responsesContainer">
            <div class="no-responses">
                Waiting for student responses<span class="waiting-indicator"></span>
            </div>
        </div>
    </div>

    <!-- Rankings Modal -->
    <div id="rankingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 40px auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="font-size: 28px; font-weight: bold; color: #1a202c;">üèÜ Course Rankings</h2>
                <button onclick="closeRankings()" style="background: #e2e8f0; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; color: #4a5568;">√ó</button>
            </div>
            <div id="rankingsContent" style="min-height: 200px;">
                <div style="text-align: center; padding: 40px; color: #718096;">
                    Loading rankings...
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const pushId = urlParams.get('pushId');
        const quizId = urlParams.get('quizId');
        const token = urlParams.get('token');

        let socket;
        let responses = [];
        let isRevealed = false;
        let targetStudentsCount = 0;
        let quizData = null;

        // Connect to socket
        function connectSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to server - authenticating...');
                socket.emit('auth', { token });
            });

            socket.on('auth_ok', (data) => {
                console.log('‚úì Authenticated as teacher for monitor');
                updateConnectionStatus(true);
                console.log('Monitor watching for pushId:', pushId, 'quizId:', quizId);
                
                // Request initial data after successful auth
                if (pushId) {
                    fetchQuizData();
                    fetchExistingResponses();
                }
            });

            socket.on('auth_error', (data) => {
                console.error('‚úó Authentication failed:', data.message);
                updateConnectionStatus(false);
                document.getElementById('quizTitle').textContent = 'Authentication Error';
            });

            socket.on('auth_error', (data) => {
                console.error('‚úó Authentication failed:', data.message);
                updateConnectionStatus(false);
                document.getElementById('quizTitle').textContent = 'Authentication Error';
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
            });

            socket.on('quiz_response', (data) => {
                console.log('=== QUIZ RESPONSE EVENT ===');
                console.log('Received data:', data);
                console.log('Monitor pushId:', pushId);
                console.log('Monitor quizId:', quizId);
                
                // Normalize IDs for comparison
                const dataPushId = data.push_id ? String(data.push_id).trim() : '';
                const dataQuizId = data.quiz_id ? String(data.quiz_id).trim() : '';
                const monitorPushId = pushId ? String(pushId).trim() : '';
                const monitorQuizId = quizId ? String(quizId).trim() : '';
                
                console.log('Normalized - data.push_id:', dataPushId);
                console.log('Normalized - data.quiz_id:', dataQuizId);
                console.log('Normalized - monitor.pushId:', monitorPushId);
                console.log('Normalized - monitor.quizId:', monitorQuizId);
                
                const pushIdMatch = dataPushId && monitorPushId && dataPushId === monitorPushId;
                const quizIdMatch = dataQuizId && monitorQuizId && dataQuizId === monitorQuizId;
                
                console.log('Match pushId?', pushIdMatch);
                console.log('Match quizId?', quizIdMatch);
                
                if (pushIdMatch || quizIdMatch) {
                    console.log('‚úì Response matches - handling');
                    handleResponse(data);
                } else {
                    console.log('‚úó Response does not match - ignoring');
                }
            });
        }

        async function fetchExistingResponses() {
            try {
                // Fetch responses that may already exist for this push
                const response = await fetch(`/api/pushes/${pushId}/responses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Existing responses loaded:', data);
                    if (data.responses && Array.isArray(data.responses)) {
                        data.responses.forEach(resp => {
                            handleResponse({
                                push_id: pushId,
                                quiz_id: resp.quiz_id,
                                user_id: resp.user_id,
                                username: resp.username,
                                display_name: resp.display_name,
                                elapsed_ms: resp.elapsed_ms,
                                answered_at: resp.answered_at,
                                status: resp.status,
                                is_correct: resp.is_correct
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching existing responses:', error);
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.remove('disconnected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
            }
        }

        async function fetchQuizData() {
            try {
                const response = await fetch(`/api/pushes/${pushId}/details`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    quizData = data;
                    document.getElementById('quizTitle').textContent = data.quiz_title || 'Quiz Monitor';
                    document.getElementById('quizIdDisplay').textContent = `Push ID: ${pushId.substring(0, 8)}...`;
                    targetStudentsCount = data.target_students_count || 0;
                    updateStats();
                }
            } catch (error) {
                console.error('Error fetching quiz data:', error);
            }
        }

        function handleResponse(data) {
            console.log('handleResponse called with:', data);
            
            // Check if response already exists
            const existingIndex = responses.findIndex(r => r.user_id === data.user_id);
            
            const responseData = {
                user_id: data.user_id,
                display_name: data.display_name || data.username,
                elapsed_ms: data.elapsed_ms,
                status: data.status,
                is_correct: data.is_correct,
                answered_at: data.answered_at || new Date().toISOString(),
                _updated: Date.now() // Add timestamp to force update
            };

            if (existingIndex >= 0) {
                console.log('Updating existing response for:', responseData.display_name);
                responses[existingIndex] = responseData;
            } else {
                console.log('Adding new response for:', responseData.display_name);
                responses.push(responseData);
            }

            console.log('Total responses now:', responses.length);
            renderResponses();
            updateStats();
        }

        function renderResponses() {
            const container = document.getElementById('responsesContainer');
            
            console.log('renderResponses called, total responses:', responses.length);
            
            if (responses.length === 0) {
                container.innerHTML = `
                    <div class="no-responses">
                        Waiting for student responses<span class="waiting-indicator"></span>
                    </div>
                `;
                return;
            }

            // Sort by answered_at (most recent first), then by _updated for tie-breaking
            const sortedResponses = [...responses].sort((a, b) => {
                const timeA = new Date(a.answered_at).getTime();
                const timeB = new Date(b.answered_at).getTime();
                
                if (timeB !== timeA) {
                    return timeB - timeA; // Most recent first
                }
                // If same time, use update timestamp
                return (b._updated || 0) - (a._updated || 0);
            });

            console.log('Sorted responses (newest first):', sortedResponses.map(r => r.display_name));

            container.innerHTML = sortedResponses.map(response => {
                const timeTaken = response.elapsed_ms ? Math.round(response.elapsed_ms / 1000) : 0;
                const correctnessClass = response.is_correct ? 'correct' : 'incorrect';
                const correctnessSymbol = response.is_correct ? '‚úì' : '‚úó';
                const revealedClass = isRevealed ? 'revealed' : '';
                const itemClass = isRevealed ? correctnessClass : '';

                return `
                    <div class="response-item ${itemClass}">
                        <div class="response-info">
                            <div class="student-name">${response.display_name}</div>
                            <div class="response-meta">
                                <div class="time-taken">
                                    ‚è±Ô∏è ${timeTaken}s
                                </div>
                                <div>${new Date(response.answered_at).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        <div class="correctness ${correctnessClass} ${revealedClass}">
                            ${correctnessSymbol}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const correctCount = responses.filter(r => r.is_correct === true).length;
            const incorrectCount = responses.filter(r => r.is_correct === false).length;
            const waitingCount = Math.max(0, targetStudentsCount - responses.length);

            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('waitingCount').textContent = waitingCount;
        }

        function revealCorrectness() {
            isRevealed = true;
            document.getElementById('revealBtn').style.display = 'none';
            document.getElementById('hideBtn').style.display = 'inline-block';
            renderResponses();
        }

        function hideCorrectness() {
            isRevealed = false;
            document.getElementById('revealBtn').style.display = 'inline-block';
            document.getElementById('hideBtn').style.display = 'none';
            renderResponses();
        }

        function clearResponses() {
            if (confirm('Clear all responses from this monitor?')) {
                responses = [];
                renderResponses();
                updateStats();
            }
        }

        async function showRankings() {
            const modal = document.getElementById('rankingsModal');
            const content = document.getElementById('rankingsContent');
            
            modal.style.display = 'block';
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">Loading rankings...</div>';
            
            try {
                const courseId = quizData?.course_id;
                if (!courseId) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53e3e;">‚ö†Ô∏è This quiz is not associated with a course</div>';
                    return;
                }
                
                const response = await fetch(`/api/courses/${courseId}/scores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch rankings');
                }
                
                const data = await response.json();
                const rankings = data.scores || [];
                
                if (rankings.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">No scores available yet</div>';
                    return;
                }
                
                // Render rankings table
                content.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Rank</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Student</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Total Score</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Answered</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Correct</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Incorrect</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Accuracy</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankings.map((student, index) => {
                                const rank = index + 1;
                                const accuracy = student.answered_count > 0 
                                    ? Math.round((student.correct_count / student.answered_count) * 100) 
                                    : 0;
                                const rankBadge = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                                const rowStyle = rank <= 3 ? 'background: #f0fff4;' : '';
                                
                                return `
                                    <tr style="${rowStyle} border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 12px; font-size: 18px; font-weight: bold;">${rankBadge}</td>
                                        <td style="padding: 12px; font-weight: 500; color: #2d3748;">${student.display_name || student.username}</td>
                                        <td style="padding: 12px; text-align: center; font-size: 20px; font-weight: bold; color: #667eea;">${student.total_score}</td>
                                        <td style="padding: 12px; text-align: center; color: #718096;">${student.answered_count}</td>
                                        <td style="padding: 12px; text-align: center; color: #38a169;">${student.correct_count}</td>
                                        <td style="padding: 12px; text-align: center; color: #e53e3e;">${student.incorrect_count}</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${accuracy >= 80 ? '#38a169' : accuracy >= 60 ? '#d69e2e' : '#e53e3e'};">${accuracy}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading rankings:', error);
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53e3e;">‚ö†Ô∏è Failed to load rankings</div>';
            }
        }

        function closeRankings() {
            document.getElementById('rankingsModal').style.display = 'none';
        }

        // Initialize
        if (token && (pushId || quizId)) {
            connectSocket();
        } else {
            document.getElementById('quizTitle').textContent = 'Invalid URL parameters';
            document.querySelector('.no-responses').textContent = 'Missing required parameters (token, pushId)';
        }
    </script>
</body>
</html>
